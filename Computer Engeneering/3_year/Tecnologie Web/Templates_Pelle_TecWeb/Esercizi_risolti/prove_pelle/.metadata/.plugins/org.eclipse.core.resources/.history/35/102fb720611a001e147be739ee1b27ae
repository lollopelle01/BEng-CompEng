package servlets;

import java.io.BufferedWriter;
import java.io.FileWriter;
import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.google.gson.Gson;

public class ServletConcorrente extends HttpServlet{

	private static final long serialVersionUID = 1L;
	Gson g;
	
	@SuppressWarnings("unchecked")
	@Override
	public void init() throws ServletException {
		
	}

	@SuppressWarnings("unchecked")
	@Override
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// Ho ricevuto il testo tramite una post, faccio due thread e assegno a ognuno di loro la parte di codice
		
		// Estraggo i parametri
		String testo = request.getParameter("text_area");
		int len = testo.length();
		String fileName = request.getParameter("file_name");
		
		// Creo ed assegno i thread
		new ServletConcorrenteThread((String) testo.subSequence(0, len/2), false, fileName, response).start();
		new ServletConcorrenteThread((String) testo.subSequence(len/2, len), true, fileName, response).start();
		
		
		
	}
	
}

class ServletConcorrenteThread extends Thread {
	private String testo;
	private boolean modalita; //true: A->a		false: a->A
	private String fileName;
	private HttpServletResponse response;
	
    public ServletConcorrenteThread(String testo, boolean modalita, String fileName, HttpServletResponse response) {
		super();
		this.testo = testo;
		this.modalita = modalita;
		this.fileName = fileName;
		this.response = response;
	}

	@Override
    public synchronized void run() {
		
		try {
			BufferedWriter bw = new BufferedWriter(new FileWriter(fileName, true));
			
			if (!this.modalita) { // a->A
				int numCharMod = this.testo.replaceFirst("[^a-z]", "").length();
				bw.write(this.testo.toUpperCase());
				this.response.getWriter().println("Numero caratteri modificati (a->A): " + numCharMod);
	        }
	        else { // A->a
	        	bw.write(this.testo.toLowerCase());
	        }
			bw.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
		
    }
}
