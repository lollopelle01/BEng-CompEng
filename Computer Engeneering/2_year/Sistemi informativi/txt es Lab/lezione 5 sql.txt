GRANT CREATEIN, ALTERIN, DROPIN
ON SCHEMA A0971455
TO USER A0970548;


CREATE TABLE A0970548.ATTORE(
	NOME VARCHAR(500) NOT NULL PRIMARY KEY,
	ANNODINASCITA INT NOT NULL,
	FILMDEBUTTO VARCHAR(300)
);


GRANT ALL
ON TABLE A0970548.ATTORE
TO USER A0970548;

ALTER TABLE A0970548.ATTORE
ADD CONSTRAINT FK_PROT FOREIGN KEY (FILMDEBUTTO)
REFERENCES A0971455.FILM;


INSERT INTO A0970548.ATTORE(TITOLO, ANNO)
VALUES ('Mission Impossible',1996),('Forrest Gump',1994);

UPDATE A0971455.FILM
SET A0971455.FILM.PROTAGONISTA = 'Tom Cruise'
WHERE A0971455.FILM.TITOLO = 'Mission Impossible';

UPDATE A0971455.FILM
SET A0971455.FILM.PROTAGONISTA = 'Tom Hanks'
WHERE A0971455.FILM.TITOLO = 'Forrest Gump';

ALTER TABLE A0971455.FILM
ALTER COLUMN PROTAGONISTA SET NOT NULL;


--4)
CREATE OR REPLACE VIEW A0971455.DEBUTTANTI(FILM,ANNO,NUMATTORI)
AS(
SELECT F.TITOLO, F.ANNO, COUNT(A.FILMDEBUTTO)
    FROM A0971455.FILM f JOIN A0970548.ATTORE a ON(F.TITOLO=A.FILMDEBUTTO)
    GROUP BY F.TITOLO, F.ANNO
);

INSERT INTO B16884.CASCATA VALUES ('PELLE',CURRENT USER);

GRANT ALL
ON TABLE B16884.CASCATA
TO USER A0970548, A0970455, A0978548;

--Q1)chi sono gli username che, direttamente o indirettamente, gli hanno
--dato il GRANT, e a che “distanza minima” da lui sono. A chi, direttamente o indirettamente,
--ha dato il GRANT, e a che“distanza minima” sono.

WITH CONCEDENTI(DA, A, POS)
AS (
	SELECT T.GRANTOR, T.GRANTEE, 1
	FROM SYSCAT.TABAUTH T
	WHERE T.GRANTOR <> 'SYSIBM'
	AND T.TABSCHEMA = 'B16884'
	AND T.TABNAME = 'CASCATA'
		UNION ALL 
	SELECT T.GRANTOR, C.A, C.POS+1
	FROM SYSCAT.TABAUTH T, CONCEDENTI C
	WHERE C.DA = T.GRANTEE
	AND T.GRANTOR <> 'SYSIBM'
	AND T.TABSCHEMA = 'B16884'
	AND T.TABNAME = 'CASCATA'
	AND C.POS+1<=5
	)
SELECT C.DA, MIN(C.POS) AS DIST
FROM CONCEDENTI C
WHERE C.A=CURRENT USER
GROUP BY C.DA
ORDER BY DIST;

--Q2) Come 1, ma aggiungendo informazione, in forma di stringhe, sui percorsi (catene di usernames)
WITH CONCEDENTI(DA, A, POS, PATH)
AS (
	SELECT T.GRANTOR, T.GRANTEE, 1, VARCHAR(T.GRANTOR, 2000)
	FROM SYSCAT.TABAUTH T
	WHERE T.GRANTOR <> 'SYSIBM'
	AND T.TABSCHEMA = 'B16884'
	AND T.TABNAME = 'CASCATA'
		UNION ALL 
	SELECT T.GRANTOR, C.A, C.POS+1, T.GRANTOR || ' - ' || C.PATH
	FROM SYSCAT.TABAUTH T, CONCEDENTI C
	WHERE C.DA = T.GRANTEE
	AND T.GRANTOR <> 'SYSIBM'
	AND T.TABSCHEMA = 'B16884'
	AND T.TABNAME = 'CASCATA'
	AND C.PATH NOT LIKE '%'|| T.GRANTOR ||
	-- 'perchè fa '%'|| T.GRANTOR ||   e non '%'|| T.GRANTOR ||'%'  ?'
	)
SELECT CA.NICK, C.DA, C.A, MIN(C.POS) AS DIST, C.PATH
FROM CONCEDENTI C ,B16884.CASCATA CA 
WHERE C.DA=CA.USERNAME
GROUP BY C.DA, C.A, CA.NICK, C.PATH 
ORDER BY DIST DESC;

--Q3) Come 2, ma evitando la formazione di cicli