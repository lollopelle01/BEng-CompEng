SURICATA 2!

--CONSEGNA
Il file di tipo pcap assegnato è il tracciato di un traffico mqtt tra un subscriber e un publisher sul broker mosquitto.

( Per informazioni su mqtt e mosquitto riprendere le slide su TLS)

Vostro compito è quello di creare una regola suricata che scateni un alert ogni volta che nel contenuto del pacchetto MQTT ci sia il contenuto “flag”

Se predisposta correttamente, nei log di suricata dovreste essere in grado di vedere il contenuto dei pacchetti

Nel contenuto dei pacchetti è possibile trovare “pezzi” di una flag nel formato SEC{qualcosa}, che potete ricostruire e sottomettere (insieme alla regola!) sul portale virtuale.

ATTENZIONE: Per poter vedere il contenuto dei pacchetti nei log di suricata è necessario abilitare la funzionalità “payload-printable”. Cercare nel file di configurazione di suricata la suddetta feature e abilitarla se disabilitata.

Modalità di consegna:
- Consegnare il file report.txt che contiene:
-- La regola usata per identificare il traffico con suricata.
-- lo script/comando usato per parsare il log di suricata e ricostruire la flag
-- La flag

--RISOLUZIONE

1)UTENTE ROOT
2)Scrivo la regola e mi basta mettere nel content "flag" per trovare i pacchetti che contengono la parola flag ->
alert tcp any any -> any any (msg:"I FOUND THE FLAG IN MQTT"; content:"flag"; sid:300000301;rev:1;)
3)A questo punto bisogna parsare i log eve.json (generati dopo aver avviato suricata in modalità offline usando il file pcapp che ci ha dato il prof mediante il comando -> suricata -c /etc/suricata/suricata.yaml -r Scrivania/mqtt_suricata_exercise.pcapng
4)Abilitare l'opzione payload-printable in suricata.yaml
5)Usiamo jq -> tool per stampare e manipolare in formato leggibile i file json: se non è scaricato fare sudo apt install jq
6)output=$(cat eve.json | jq 'select(.event_type="alert")')

first=`echo "$output" | awk -F "flag/first" '{ print $2 }' | awk -F "(0|\")" '{ print $1 }'`
second=`echo "$output" | awk -F "flag/second" '{ print $2 }' | awk -F "(0|\")" '{ print $1 }'`
third=`echo "$output" | awk -F "flag/third" '{ print $2 }' | awk -F "(0|\")" '{ print $1 }'`

echo ${first}${second}${third}
7) flag: SEC{suricata_mqtt_nids}
