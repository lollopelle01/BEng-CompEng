CREATE SCHEMA "00971455";
CREATE TABLE Modelli (
Modello varchar(20) NOT NULL PRIMARY KEY,
Marca varchar(20) NOT NULL,
Cilindrata int NOT NULL,
Alimentazione varchar(50) NOT NULL,
VelMax int NOT NULL,
PrezzoListino dec(8,2) NOT NULL
);

CREATE TABLE Rivenditori (
CodR varchar(30) NOT NULL PRIMARY KEY,
Citta varchar(100) NOT NULL
);

CREATE TABLE Auto(
Targa varchar(10) NOT NULL PRIMARY KEY,
Modello varchar(20) NOT NULL REFERENCES Modelli(modello),
CodR varchar(30) NOT NULL REFERENCES Rivenditori(CodR),
PrezzoVendita dec(8,2) NOT NULL,
Km int NOT NULL,
Anno int NOT NULL,
Venduta varchar(2) CHECK (Venduta='si')
CONSTRAINT AnnoValido CHECK (Anno<=2021)
);

INSERT INTO MODELLI (Modello, MARCA, CILINDRATA, ALIMENTAZIONE, VELMAX, PREZZOLISTINO)
VALUES ('Modello1', 'MARCA1', 100, 'benzina', 200, 50000.00);
INSERT INTO MODELLI (Modello, MARCA, CILINDRATA, ALIMENTAZIONE, VELMAX, PREZZOLISTINO)
VALUES ('Modello2', 'MARCA2', 80, 'benzina', 150, 20000.00);
INSERT INTO MODELLI (Modello, MARCA, CILINDRATA, ALIMENTAZIONE, VELMAX, PREZZOLISTINO)
VALUES ('Modello3', 'MARCA3', 200, 'benzina', 300, 100000.00);

INSERT INTO RIVENDITORI (CodR, Citta)
VALUES ('rivenditore1', 'Bologna');
INSERT INTO RIVENDITORI (CodR, Citta)
VALUES ('rivenditore2', 'Bologna');
INSERT INTO RIVENDITORI (CodR, Citta)
VALUES ('rivenditore3', 'Milano');

INSERT INTO AUTO (targa, modello, CODR, PREZZOVENDITA, KM, ANNO, VENDUTA)
VALUES ('targa1', 'Modello1', 'rivenditore1', 30000.00, 50000, 2020, 'si');
INSERT INTO AUTO (targa, modello, CODR, PREZZOVENDITA, KM, ANNO, VENDUTA)
VALUES ('targa2', 'Modello2', 'rivenditore2', 50000.00, 0, 2019, 'si');
INSERT INTO AUTO (targa, modello, CODR, PREZZOVENDITA, KM, ANNO)
VALUES ('targa5', 'Modello2', 'rivenditore2', 50000.00, 0, 2019);
INSERT INTO AUTO (targa, modello, CODR, PREZZOVENDITA, KM, ANNO)
VALUES ('targa3', 'Modello3', 'rivenditore3', 60000.00, 70000, 2021);
INSERT INTO AUTO (targa, modello, CODR, PREZZOVENDITA, KM, ANNO)
VALUES ('targa4', 'Modello3', 'rivenditore3', 60000.00, 70000, 2021);
INSERT INTO AUTO (targa, modello, CODR, PREZZOVENDITA, KM, ANNO, VENDUTA)
VALUES ('targa6', 'Modello3', 'rivenditore3', 60000.00, 70000, 2021, 'si');
INSERT INTO AUTO (targa, modello, CODR, PREZZOVENDITA, KM, ANNO, VENDUTA)
VALUES ('targa7', 'Modello3', 'rivenditore3', 60000.00, 70000, 2020, 'si');


--Q1)
SELECT a.*
FROM (MODELLI m JOIN AUTO a ON (a.MODELLO=m.MODELLO)) JOIN RIVENDITORI r ON (a.CODR=r.CODR)
WHERE a.MODELLO='Modello3' AND r.CITTA ='Milano' AND a.VENDUTA IS NULL AND (a.PREZZOVENDITA<=0.70*m.PREZZOLISTINO);

--Q2)
SELECT avg(a.PREZZOVENDITA) AS Media
FROM (MODELLI m JOIN AUTO a ON (a.MODELLO=m.MODELLO)) JOIN RIVENDITORI r ON (a.CODR=r.CODR)
WHERE m.ALIMENTAZIONE='benzina' AND m.CILINDRATA <1000 AND (2021-a.ANNO)>=5 AND a.KM<=80000;

--Q3)
SELECT m.modello AS modello, min(a.PREZZOVENDITA) AS prezzoMin
FROM (MODELLI m JOIN AUTO a ON (a.MODELLO=m.MODELLO)) JOIN RIVENDITORI r ON (a.CODR=r.CODR)
WHERE m.VELMAX >180
AND r.CITTA ='Bologna'
AND a.VENDUTA IS NULL
GROUP BY m.MODELLO;

--Q4)
SELECT r.CITTA, COUNT(*) AS Trattate, Count(a.VENDUTA) AS Vendute
FROM (MODELLI m JOIN AUTO a ON (a.MODELLO=m.MODELLO)) JOIN RIVENDITORI r ON (a.CODR=r.CODR)
GROUP BY r.CITTA;

--Q5)
SELECT r.*
FROM (MODELLI m JOIN AUTO a ON (a.MODELLO=m.MODELLO)) JOIN RIVENDITORI r ON (a.CODR=r.CODR)
GROUP BY r.CITTA, r.CODR
HAVING Count(a.VENDUTA)<=0.8*COUNT(*)
ORDER BY r.CITTA, r.CODR;

--Q6)
SELECT r.*, m.*
FROM (MODELLI m JOIN AUTO a ON (a.MODELLO=m.MODELLO)) JOIN RIVENDITORI r ON (a.CODR=r.CODR)
EXCEPT
SELECT r.*, m.*
FROM (MODELLI m JOIN AUTO a ON (a.MODELLO=m.MODELLO)) JOIN RIVENDITORI r ON (a.CODR=r.CODR)
WHERE a.VENDUTA IS NOT NULL;

--Q7)
SELECT DISTINCT r.codr, count(a.VENDUTA) AS vendute
FROM (MODELLI m JOIN AUTO a ON (a.MODELLO=m.MODELLO)) JOIN RIVENDITORI r ON (a.CODR=r.CODR)
GROUP BY r.codr
HAVING avg(a.PREZZOVENDITA)<=57000;

--Q8) Per ogni auto A, il numero di auto vendute a un prezzo minore di quello di A
SELECT DISTINCT a1.TARGA, count(*) AS VendutaPrixMin
FROM AUTO a1, AUTO a2
WHERE a1.VENDUTA IS NOT NULL
AND a2.VENDUTA IS NOT NULL
AND a1.PREZZOVENDITA >a2.PREZZOVENDITA
AND a1.TARGA != a2.TARGA
GROUP BY a1.TARGA ;

--Q9) Per ogni anno e ogni modello, il rapporto medio tra prezzo di vendita e prezzo di listino,
--considerando un minimo di 2 auto vendute
SELECT DISTINCT a.ANNO, a.MODELLO, AVG(a.PREZZOVENDITA/m.PREZZOLISTINO) AS rapportoVL
FROM (MODELLI m JOIN AUTO a ON (a.MODELLO=m.MODELLO)) JOIN RIVENDITORI r ON (a.CODR=r.CODR)
GROUP BY a.ANNO, a.MODELLO
HAVING COUNT(a.VENDUTA)>=1;