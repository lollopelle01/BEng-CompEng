/*ESERCIZIO 1*/
CREATE SCHEMA "00971455";
CREATE TABLE Utenti (
	Tessera varchar(50) NOT NULL PRIMARY KEY,
	Nome varchar(50) NOT NULL ,
	Cognome varchar(50) NOT NULL ,
	Telefono char(10) NOT NULL,
	UNIQUE(Nome, Cognome, Telefono)
);

CREATE TABLE Libri (
	Codice varchar(50) NOT NULL PRIMARY KEY,
	Titolo varchar(50) NOT NULL,
	Autori varchar(50) NOT NULL DEFAULT 'Anonimo',
	Note varchar(300)
);

CREATE TABLE Prestiti (
	Codicelibro varchar(50) NOT NULL REFERENCES Libri(Codice) ON DELETE CASCADE,
	Tessera varchar(50) NOT NULL REFERENCES Utenti(Tessera) ON DELETE CASCADE,
	Dataout date NOT NULL,
	Data_in date,
	PRIMARY KEY(Codicelibro, Tessera, Dataout),
	CONSTRAINT DataValida CHECK(DATAOUT<=DATA_IN)
);

/*ESERCIZIO 2*/
INSERT INTO UTENTI(TESSERA, NOME, COGNOME, TELEFONO)
	VALUES ('00971455', 'Lorenzo', 'Pellegrino', '3246281804');
INSERT INTO UTENTI(TESSERA, NOME, COGNOME, TELEFONO)
	VALUES ('00971456', 'Alessandro', 'Pellegrino', '3397452743');
INSERT INTO LIBRI (CODICE , TITOLO , AUTORI , NOTE)
	VALUES ('1.1.1', '1984', 'Orwell', 'molto bello');
INSERT INTO LIBRI (CODICE , TITOLO , AUTORI , NOTE)
	VALUES ('1.1.2', 'Narnia bella', 'Pippo', 'nsomma oh');
INSERT INTO PRESTITI (CODICELIBRO , TESSERA , DATAOUT , DATA_IN)
	VALUES ('1.1.1', '00971455', '09.02.2010', '09.02.2021');
INSERT INTO PRESTITI (CODICELIBRO , TESSERA , DATAOUT)
	VALUES ('1.1.2', '00971456', '09.02.2010');

UPDATE UTENTI 
	SET TELEFONO ='1234567890' WHERE TESSERA ='00971456';
UPDATE LIBRI 
	SET NOTE ='figo' WHERE CODICE ='1.1.1';
UPDATE PRESTITI 
	SET DATA_IN ='10.05.2040' WHERE CODICELIBRO ='1.1.2' AND TESSERA ='00971456' AND DATAOUT ='9.2.2010';

DELETE FROM UTENTI 
	WHERE TESSERA='00971455' AND NOME='Lorenzo' AND COGNOME='Pellegrino' AND TELEFONO='3246281804';
DELETE FROM LIBRI 
	WHERE CODICE='1.1.2' AND TITOLO='Narnia' AND AUTORI='Pippo' AND NOTE='nsomma';

/*ESERCIZIO 3*/
--Q1
SELECT *
FROM LIBRI l
	WHERE l.TITOLO LIKE '%bella';

--Q2
SELECT *
FROM UTENTI u
	WHERE u.COGNOME = 'Pellegrino';

--Q3
SELECT *
FROM PRESTITI p 
	WHERE YEAR(p.DATAOUT)='2010' OR YEAR(p.DATA_IN)='2010';

--Q4
SELECT *
FROM PRESTITI p 
	WHERE YEAR(p.DATAOUT)!=YEAR(p.DATA_IN);

--Q5
SELECT p.CODICELIBRO 
FROM PRESTITI p, UTENTI u 
	WHERE u.NOME ='Alessandro' AND u.COGNOME ='Pellegrino' AND u.TELEFONO ='1234567890' AND p.TESSERA =u.TESSERA;

--Q6
SELECT p.CODICELIBRO 
FROM PRESTITI p, UTENTI u 
	WHERE u.NOME ='Alessandro' AND  u.COGNOME ='Pellegrino' AND u.TELEFONO ='1234567890' AND p.TESSERA =u.TESSERA AND 
		YEAR(p.DATAOUT) BETWEEN '2010' AND '2040';
	
--Q7
SELECT l.*
FROM PRESTITI p, UTENTI u, LIBRI l 
	WHERE u.NOME ='Alessandro' AND  u.COGNOME ='Pellegrino' AND u.TELEFONO ='1234567890' AND p.TESSERA =u.TESSERA AND 
		YEAR(p.DATAOUT) BETWEEN '2010' AND '2040' AND l.CODICE =p.CODICELIBRO;
	
--Q8
SELECT DISTINCT u.*
FROM (PRESTITI AS p1 JOIN PRESTITI AS p2 ON (p1.TESSERA=p2.TESSERA)) JOIN UTENTI AS u ON (p1.TESSERA=u.TESSERA)
	WHERE YEAR(p1.DATAOUT)='2010' AND  YEAR(p2.DATAOUT)='2010' AND p1.CODICELIBRO !=p2.CODICELIBRO;
	
--Q9
SELECT u.*
FROM UTENTI u
	EXCEPT 
SELECT u.*
FROM PRESTITI p JOIN Utenti u ON (p.TESSERA=u.TESSERA)
	WHERE YEAR(p.DATAOUT)=2017;

/* soluzione alternativa:
 * SELECT u.*
FROM utenti u LEFT JOIN PRESTITI p ON(u.TESSERA=p.TESSERA) AND YEAR(p.DATAOUT)=2017
	WHERE p.CODICELIBRO IS NULL ;
 */

--Q10
SELECT DISTINCT u.*
FROM UTENTI u 
	EXCEPT 
SELECT DISTINCT u.*
FROM (UTENTI u JOIN PRESTITI p on(u.TESSERA=p.TESSERA)) JOIN LIBRI l ON (p.CODICELIBRO=l.CODICE)
	WHERE l.AUTORI='Anonimo' AND l.NOTE LIKE '%nsomma%' AND l.NOTE LIKE '%oh%';

/* soluzione alternativa
 * SELECT U.TESSERA
FROM   UTENTI U
  EXCEPT
SELECT P.TESSERA
FROM   PRESTITI P, LIBRI L
WHERE  P.CODICELIBRO = L.CODICE
and		l.AUTORI='Anonimo'
AND    LOWER(L.NOTE) LIKE '%figo'
AND    LOWER(L.NOTE) LIKE '%nsomma' ;
 */

DROP TABLE UTENTI;
DROP TABLE LIBRI;
DROP TABLE PRESTITI;